---
# =============================================================================
# AI Agent Development Environment
# Ansible playbook matching Claude Code on the Web specification
# Uses mise for reproducible language version management
# =============================================================================

- name: Setup AI Agent Development Environment
  hosts: all
  become: true
  vars:
    mise_data_dir: /mise
    mise_config_dir: /mise
    mise_cache_dir: /mise/cache
    mise_install_path: /usr/local/bin/mise
    workspace_dir: /workspace

    # Tool versions
    python_version: "3.11"
    node_version: "22"
    go_version: "1.24"
    rust_version: "latest"
    java_version: "openjdk-21"
    ruby_version: "3.3"

    # ==========================================================================
    # Optional: Pass these via environment or --extra-vars for automated setup
    # ==========================================================================
    # Tailscale auth key (get from https://login.tailscale.com/admin/settings/keys)
    tailscale_authkey: "{{ lookup('env', 'TAILSCALE_AUTHKEY') | default('', true) }}"

    # GitHub CLI token (get from https://github.com/settings/tokens)
    gh_token: "{{ lookup('env', 'GH_TOKEN') | default('', true) }}"

    # Git user config
    git_user_name: "{{ lookup('env', 'GIT_USER_NAME') | default('', true) }}"
    git_user_email: "{{ lookup('env', 'GIT_USER_EMAIL') | default('', true) }}"

    # AI Agent API keys
    anthropic_api_key: "{{ lookup('env', 'ANTHROPIC_API_KEY') | default('', true) }}"
    openai_api_key: "{{ lookup('env', 'OPENAI_API_KEY') | default('', true) }}"

    # SSH private key (base64 encoded) for git operations
    ssh_private_key_b64: "{{ lookup('env', 'SSH_PRIVATE_KEY_B64') | default('', true) }}"

    # System packages
    system_packages:
      # Build essentials
      - build-essential
      - ca-certificates
      - curl
      - git
      - wget
      - gnupg
      - software-properties-common
      # Development headers
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - libncursesw5-dev
      - libffi-dev
      - liblzma-dev
      - libxml2-dev
      - libxmlsec1-dev
      - tk-dev
      - xz-utils
      # C/C++ toolchain
      - gcc
      - g++
      - clang
      - cmake
      - ninja-build
      - pkg-config
      # Database clients
      - postgresql-client
      - redis-tools
      - sqlite3
      # Utilities
      - jq
      - vim
      - tmux
      - unzip
      - sudo
      - locales
      - less
      - openssh-client
      - git-lfs
      - ripgrep
      - fd-find

    # Node.js global packages
    npm_global_packages:
      - pnpm
      - yarn
      - typescript
      - eslint
      - prettier
      - ts-node
      - nodemon
      - playwright
      - http-server
      - serve

    # Python packages
    pip_packages:
      - pyyaml
      - jinja2
      - requests
      - cryptography
      - conan

  environment:
    MISE_DATA_DIR: "{{ mise_data_dir }}"
    MISE_CONFIG_DIR: "{{ mise_config_dir }}"
    MISE_CACHE_DIR: "{{ mise_cache_dir }}"
    MISE_INSTALL_PATH: "{{ mise_install_path }}"
    PATH: "{{ mise_data_dir }}/shims:/usr/local/bin:/usr/bin:/bin"

  tasks:
    # =========================================================================
    # System Dependencies
    # =========================================================================
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install system packages
      ansible.builtin.apt:
        name: "{{ system_packages }}"
        state: present
        install_recommends: false

    - name: Create fd symlink (Ubuntu installs as fdfind)
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: /usr/local/bin/fd
        state: link
      ignore_errors: true

    - name: Generate locale
      ansible.builtin.locale_gen:
        name: en_US.UTF-8
        state: present

    - name: Set locale environment
      ansible.builtin.lineinfile:
        path: /etc/environment
        line: "{{ item }}"
        create: true
        mode: "0644"
      loop:
        - "LANG=en_US.UTF-8"
        - "LC_ALL=en_US.UTF-8"

    # =========================================================================
    # Tailscale
    # =========================================================================
    - name: Install Tailscale
      ansible.builtin.shell: |
        curl -fsSL https://tailscale.com/install.sh | sh
      args:
        creates: /usr/bin/tailscale

    - name: Authenticate Tailscale
      ansible.builtin.command: tailscale up --authkey={{ tailscale_authkey }}
      when: tailscale_authkey | length > 0
      changed_when: true

    # =========================================================================
    # Git Configuration
    # =========================================================================
    - name: Mark workspace as safe directory
      community.general.git_config:
        scope: system
        name: safe.directory
        value: "{{ workspace_dir }}"

    - name: Install Git LFS
      ansible.builtin.command: git lfs install
      args:
        creates: /root/.gitconfig
      changed_when: true

    - name: Configure git user name
      community.general.git_config:
        scope: system
        name: user.name
        value: "{{ git_user_name }}"
      when: git_user_name | length > 0

    - name: Configure git user email
      community.general.git_config:
        scope: system
        name: user.email
        value: "{{ git_user_email }}"
      when: git_user_email | length > 0

    # =========================================================================
    # mise Installation
    # =========================================================================
    - name: Create mise directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ mise_data_dir }}"
        - "{{ mise_config_dir }}"
        - "{{ mise_cache_dir }}"

    - name: Install mise
      ansible.builtin.shell: |
        curl https://mise.run | sh
      args:
        creates: "{{ mise_install_path }}"

    - name: Create mise config
      ansible.builtin.copy:
        dest: "{{ mise_config_dir }}/config.toml"
        mode: "0644"
        content: |
          [tools]
          # Languages - matching Claude Code on the Web spec
          python = "{{ python_version }}"
          node = "{{ node_version }}"
          go = "{{ go_version }}"
          rust = "{{ rust_version }}"
          java = "{{ java_version }}"
          ruby = "{{ ruby_version }}"
          # php omitted - requires complex build dependencies

          # AI Coding Agents
          claude = "latest"
          codex = "latest"
          opencode = "latest"

          # Python tools
          uv = "latest"

          # CLI tools
          github-cli = "latest"

          [settings]
          experimental = true

    - name: Trust mise config
      ansible.builtin.command: "{{ mise_install_path }} trust {{ mise_config_dir }}/config.toml"
      changed_when: true

    - name: Install all mise tools
      ansible.builtin.command: "{{ mise_install_path }} install --yes"
      changed_when: true

    # =========================================================================
    # Package Managers & Global Packages
    # =========================================================================
    - name: Install npm global packages
      ansible.builtin.shell: |
        {{ mise_install_path }} exec -- npm install -g {{ npm_global_packages | join(' ') }}
      changed_when: true

    - name: Install bun via mise
      ansible.builtin.command: "{{ mise_install_path }} use -g bun@latest"
      changed_when: true

    - name: Install Python packages
      ansible.builtin.shell: |
        {{ mise_install_path }} exec -- pip install --no-cache-dir {{ pip_packages | join(' ') }}
      changed_when: true

    - name: Install Rust components
      ansible.builtin.shell: |
        {{ mise_install_path }} exec -- rustup component add clippy rustfmt
      changed_when: true

    # =========================================================================
    # Workspace Setup
    # =========================================================================
    - name: Create workspace directory
      ansible.builtin.file:
        path: "{{ workspace_dir }}"
        state: directory
        mode: "0755"

    - name: Install check-versions script
      ansible.builtin.copy:
        dest: /usr/local/bin/check-versions
        mode: "0755"
        content: |
          #!/bin/bash
          set -e
          echo "==========================================="
          echo "   AI Agent Development Environment"
          echo "==========================================="
          echo ""
          echo "System:"
          echo "  OS:      $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "  Kernel:  $(uname -r)"
          echo "  Arch:    $(uname -m)"
          echo ""
          echo "AI Coding Agents:"
          echo "  claude:   $(claude --version 2>&1 | head -1 || echo 'not found')"
          echo "  codex:    $(codex --version 2>&1 | head -1 || echo 'not found')"
          echo "  opencode: $(opencode --version 2>&1 | head -1 || echo 'not found')"
          echo ""
          echo "Languages:"
          echo "  Python:  $(python --version 2>&1 | awk '{print $2}')"
          echo "  Node.js: $(node --version)"
          echo "  Go:      $(go version | awk '{print $3}')"
          echo "  Rust:    $(rustc --version | awk '{print $2}')"
          echo "  Java:    $(java --version 2>&1 | head -1)"
          echo "  Ruby:    $(ruby --version | awk '{print $2}')"
          echo ""
          echo "Package Managers:"
          echo "  npm:     $(npm --version)"
          echo "  pnpm:    $(pnpm --version)"
          echo "  yarn:    $(yarn --version)"
          echo "  bun:     $(bun --version)"
          echo "  pip:     $(pip --version | awk '{print $2}')"
          echo "  uv:      $(uv --version | awk '{print $2}')"
          echo "  cargo:   $(cargo --version | awk '{print $2}')"
          echo ""
          echo "Build Tools:"
          echo "  gcc:     $(gcc --version | head -1)"
          echo "  clang:   $(clang --version | head -1)"
          echo "  cmake:   $(cmake --version | head -1 | awk '{print $3}')"
          echo "  make:    $(make --version | head -1)"
          echo ""
          echo "==========================================="

    # =========================================================================
    # Environment Setup
    # =========================================================================
    - name: Add mise to system profile
      ansible.builtin.copy:
        dest: /etc/profile.d/mise.sh
        mode: "0644"
        content: |
          export MISE_DATA_DIR="{{ mise_data_dir }}"
          export MISE_CONFIG_DIR="{{ mise_config_dir }}"
          export MISE_CACHE_DIR="{{ mise_cache_dir }}"
          export MISE_INSTALL_PATH="{{ mise_install_path }}"
          export PATH="{{ mise_data_dir }}/shims:$PATH"
          eval "$({{ mise_install_path }} activate bash)"

    - name: Clean apt cache
      ansible.builtin.apt:
        autoclean: true
        autoremove: true

    # =========================================================================
    # Optional Tool Authentication (when env vars provided)
    # =========================================================================
    - name: Authenticate GitHub CLI
      ansible.builtin.shell: |
        echo "{{ gh_token }}" | {{ mise_install_path }} exec -- gh auth login --with-token
      when: gh_token | length > 0
      changed_when: true
      no_log: true

    - name: Create SSH directory
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: "0700"
      when: ssh_private_key_b64 | length > 0

    - name: Install SSH private key
      ansible.builtin.copy:
        dest: /root/.ssh/id_ed25519
        content: "{{ ssh_private_key_b64 | b64decode }}"
        mode: "0600"
      when: ssh_private_key_b64 | length > 0
      no_log: true

    - name: Add GitHub to known hosts
      ansible.builtin.known_hosts:
        name: github.com
        key: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
        state: present
      when: ssh_private_key_b64 | length > 0

    # =========================================================================
    # AI Agent Environment Variables
    # =========================================================================
    - name: Create AI agent environment file
      ansible.builtin.copy:
        dest: /etc/profile.d/ai-agents.sh
        mode: "0644"
        content: |
          # AI Agent API Keys (set via environment during provisioning)
          {% if anthropic_api_key | length > 0 %}
          export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"
          {% endif %}
          {% if openai_api_key | length > 0 %}
          export OPENAI_API_KEY="{{ openai_api_key }}"
          {% endif %}
      when: (anthropic_api_key | length > 0) or (openai_api_key | length > 0)
      no_log: true
