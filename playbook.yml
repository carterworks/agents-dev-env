---
# =============================================================================
# Development Environment
# Languages via apt, mise available for version management & AI coding agents
# =============================================================================

- name: Setup Universal Development Environment
  hosts: all
  become: true
  vars:
    mise_data_dir: /mise
    mise_config_dir: /mise
    mise_cache_dir: /mise/cache
    workspace_dir: /workspace

    # ==========================================================================
    # Optional: Pass these via environment or --extra-vars for automated setup
    # ==========================================================================
    # Tailscale auth key (get from https://login.tailscale.com/admin/settings/keys)
    tailscale_authkey: "{{ lookup('env', 'TAILSCALE_AUTHKEY') | default('', true) }}"

    # GitHub CLI token (get from https://github.com/settings/tokens)
    gh_token: "{{ lookup('env', 'GH_TOKEN') | default('', true) }}"

    # Git user config
    git_user_name: "{{ lookup('env', 'GIT_USER_NAME') | default('', true) }}"
    git_user_email: "{{ lookup('env', 'GIT_USER_EMAIL') | default('', true) }}"

    # SSH private key (base64 encoded) for git operations
    ssh_private_key_b64: "{{ lookup('env', 'SSH_PRIVATE_KEY_B64') | default('', true) }}"

    # System packages
    system_packages:
      # Build essentials
      - build-essential
      - ca-certificates
      - curl
      - git
      - wget
      - gnupg
      - software-properties-common
      # Development headers
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - libncursesw5-dev
      - libffi-dev
      - liblzma-dev
      - libxml2-dev
      - libxmlsec1-dev
      - tk-dev
      - xz-utils
      # C/C++ toolchain
      - gcc
      - g++
      - clang
      - cmake
      - ninja-build
      - pkg-config
      # Database clients
      - postgresql-client
      - redis-tools
      - sqlite3
      # Utilities
      - jq
      - vim
      - tmux
      - unzip
      - sudo
      - locales
      - less
      - openssh-client
      - git-lfs
      - ripgrep
      - fd-find

    # Language packages (via apt)
    language_packages:
      # Python
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      # Node.js (via nodesource, added separately)
      # Go
      - golang
      # Ruby
      - ruby
      - ruby-dev
      # Java
      - default-jdk
      # Rust installed via rustup

    # Node.js global packages
    npm_global_packages:
      - pnpm
      - yarn
      - typescript
      - eslint
      - prettier
      - ts-node
      - nodemon
      - playwright
      - http-server
      - serve

    # Python packages
    pip_packages:
      - pyyaml
      - jinja2
      - requests
      - cryptography
      - conan

  environment:
    MISE_DATA_DIR: "{{ mise_data_dir }}"
    MISE_CONFIG_DIR: "{{ mise_config_dir }}"
    MISE_CACHE_DIR: "{{ mise_cache_dir }}"
    PATH: "{{ mise_data_dir }}/shims:/usr/local/bin:/usr/bin:/bin"

  tasks:
    # =========================================================================
    # System Dependencies
    # =========================================================================
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install system packages
      ansible.builtin.apt:
        name: "{{ system_packages }}"
        state: present
        install_recommends: false

    # =========================================================================
    # Language Runtimes (via apt)
    # =========================================================================
    - name: Install language packages
      ansible.builtin.apt:
        name: "{{ language_packages }}"
        state: present
        install_recommends: false

    # Node.js via NodeSource (Debian's is too old)
    - name: Add NodeSource GPG key
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
        dest: /etc/apt/keyrings/nodesource.asc
        mode: "0644"

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.asc] https://deb.nodesource.com/node_22.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    # Rust via rustup (apt version is too old)
    - name: Install Rust via rustup
      ansible.builtin.shell: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      args:
        creates: /root/.cargo/bin/rustc
      environment:
        RUSTUP_HOME: /usr/local/rustup
        CARGO_HOME: /usr/local/cargo

    - name: Add Rust to system PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/rust.sh
        mode: "0644"
        content: |
          export RUSTUP_HOME=/usr/local/rustup
          export CARGO_HOME=/usr/local/cargo
          export PATH="/usr/local/cargo/bin:$PATH"

    - name: Install Rust components
      ansible.builtin.shell: |
        . /etc/profile.d/rust.sh && rustup component add clippy rustfmt
      changed_when: true

    - name: Create fd symlink (Ubuntu installs as fdfind)
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: /usr/local/bin/fd
        state: link
      ignore_errors: true

    - name: Generate locale
      ansible.builtin.locale_gen:
        name: en_US.UTF-8
        state: present

    - name: Set locale environment
      ansible.builtin.lineinfile:
        path: /etc/environment
        line: "{{ item }}"
        create: true
        mode: "0644"
      loop:
        - "LANG=en_US.UTF-8"
        - "LC_ALL=en_US.UTF-8"

    # =========================================================================
    # Tailscale
    # =========================================================================
    - name: Install Tailscale
      ansible.builtin.shell: |
        curl -fsSL https://tailscale.com/install.sh | sh
      args:
        creates: /usr/bin/tailscale

    - name: Authenticate Tailscale
      ansible.builtin.command: tailscale up --authkey={{ tailscale_authkey }}
      when: tailscale_authkey | length > 0
      changed_when: true

    # =========================================================================
    # Git Configuration
    # =========================================================================
    - name: Mark workspace as safe directory
      community.general.git_config:
        scope: system
        name: safe.directory
        value: "{{ workspace_dir }}"

    - name: Install Git LFS
      ansible.builtin.command: git lfs install
      args:
        creates: /root/.gitconfig
      changed_when: true

    - name: Configure git user name
      community.general.git_config:
        scope: system
        name: user.name
        value: "{{ git_user_name }}"
      when: git_user_name | length > 0

    - name: Configure git user email
      community.general.git_config:
        scope: system
        name: user.email
        value: "{{ git_user_email }}"
      when: git_user_email | length > 0

    # =========================================================================
    # mise Installation
    # =========================================================================
    - name: Create mise directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ mise_data_dir }}"
        - "{{ mise_config_dir }}"
        - "{{ mise_cache_dir }}"

    - name: Install mise
      ansible.builtin.shell: |
        curl https://mise.run | sh
      args:
        creates: /root/.local/bin/mise

    - name: Symlink mise to /usr/local/bin
      ansible.builtin.file:
        src: /root/.local/bin/mise
        dest: /usr/local/bin/mise
        state: link

    - name: Create mise config
      ansible.builtin.copy:
        dest: "{{ mise_config_dir }}/config.toml"
        mode: "0644"
        content: |
          [tools]
          # AI Coding Agents (frequently updated, managed via mise)
          claude = "latest"
          codex = "latest"
          opencode = "latest"

          # Additional tools available via mise if needed:
          # python = "3.12"    # Override system Python
          # node = "20"        # Override system Node
          # go = "1.22"        # Override system Go
          # uv = "latest"      # Fast Python package manager

          [settings]
          experimental = true

    - name: Trust mise config
      ansible.builtin.command: mise trust {{ mise_config_dir }}/config.toml
      changed_when: true

    - name: Install mise tools (AI coding agents)
      ansible.builtin.command: mise install --yes
      changed_when: true

    # =========================================================================
    # Package Managers & Global Packages
    # =========================================================================
    - name: Install npm global packages
      ansible.builtin.command: npm install -g {{ npm_global_packages | join(' ') }}
      changed_when: true

    - name: Install Python packages
      ansible.builtin.command: pip3 install --no-cache-dir --break-system-packages {{ pip_packages | join(' ') }}
      changed_when: true

    # Bun (fast JS runtime/bundler)
    - name: Install Bun
      ansible.builtin.shell: |
        curl -fsSL https://bun.sh/install | bash
      args:
        creates: /root/.bun/bin/bun
      environment:
        BUN_INSTALL: /usr/local

    - name: Add Bun to system PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/bun.sh
        mode: "0644"
        content: |
          export BUN_INSTALL=/usr/local
          export PATH="/usr/local/bin:$PATH"

    # uv (fast Python package manager)
    - name: Install uv
      ansible.builtin.shell: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      args:
        creates: /root/.local/bin/uv
      environment:
        UV_INSTALL_DIR: /usr/local/bin

    # GitHub CLI via apt (more stable than mise for this)
    - name: Add GitHub CLI GPG key
      ansible.builtin.get_url:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        dest: /etc/apt/keyrings/githubcli-archive-keyring.gpg
        mode: "0644"

    - name: Add GitHub CLI repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        state: present
        filename: github-cli

    - name: Install GitHub CLI
      ansible.builtin.apt:
        name: gh
        state: present
        update_cache: true

    # =========================================================================
    # Workspace Setup
    # =========================================================================
    - name: Create workspace directory
      ansible.builtin.file:
        path: "{{ workspace_dir }}"
        state: directory
        mode: "0755"

    - name: Install check-versions script
      ansible.builtin.copy:
        dest: /usr/local/bin/check-versions
        mode: "0755"
        content: |
          #!/bin/bash
          set -e
          echo "==========================================="
          echo "                Dev Env                    "
          echo "==========================================="
          echo ""
          echo "System:"
          echo "  OS:      $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "  Kernel:  $(uname -r)"
          echo "  Arch:    $(uname -m)"
          echo ""
          echo "Languages:"
          echo "  Python:  $(python3 --version 2>&1 | awk '{print $2}')"
          echo "  Node.js: $(node --version)"
          echo "  Go:      $(go version | awk '{print $3}')"
          echo "  Rust:    $(rustc --version | awk '{print $2}')"
          echo "  Java:    $(java --version 2>&1 | head -1)"
          echo "  Ruby:    $(ruby --version | awk '{print $2}')"
          echo ""
          echo "AI Coding Agents (via mise):"
          echo "  claude:   $(claude --version 2>&1 | head -1 || echo 'not installed')"
          echo "  codex:    $(codex --version 2>&1 | head -1 || echo 'not installed')"
          echo "  opencode: $(opencode --version 2>&1 | head -1 || echo 'not installed')"
          echo ""
          echo "Package Managers:"
          echo "  npm:     $(npm --version)"
          echo "  pnpm:    $(pnpm --version)"
          echo "  yarn:    $(yarn --version)"
          echo "  bun:     $(bun --version)"
          echo "  pip:     $(pip3 --version | awk '{print $2}')"
          echo "  uv:      $(uv --version 2>&1 | awk '{print $2}' || echo 'not installed')"
          echo "  cargo:   $(cargo --version | awk '{print $2}')"
          echo ""
          echo "Build Tools:"
          echo "  gcc:     $(gcc --version | head -1)"
          echo "  clang:   $(clang --version | head -1)"
          echo "  cmake:   $(cmake --version | head -1 | awk '{print $3}')"
          echo "  make:    $(make --version | head -1)"
          echo ""
          echo "==========================================="

    # =========================================================================
    # Environment Setup
    # =========================================================================
    - name: Add mise to system profile
      ansible.builtin.copy:
        dest: /etc/profile.d/mise.sh
        mode: "0644"
        content: |
          export MISE_DATA_DIR="{{ mise_data_dir }}"
          export MISE_CONFIG_DIR="{{ mise_config_dir }}"
          export MISE_CACHE_DIR="{{ mise_cache_dir }}"
          export PATH="{{ mise_data_dir }}/shims:$PATH"
          eval "$(mise activate bash)"

    - name: Clean apt cache
      ansible.builtin.apt:
        autoclean: true
        autoremove: true

    # =========================================================================
    # Optional Tool Authentication (when env vars provided)
    # =========================================================================
    - name: Authenticate GitHub CLI
      ansible.builtin.shell: |
        echo "{{ gh_token }}" | gh auth login --with-token
      when: gh_token | length > 0
      changed_when: true
      no_log: true

    - name: Create SSH directory
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        mode: "0700"
      when: ssh_private_key_b64 | length > 0

    - name: Install SSH private key
      ansible.builtin.copy:
        dest: /root/.ssh/id_ed25519
        content: "{{ ssh_private_key_b64 | b64decode }}"
        mode: "0600"
      when: ssh_private_key_b64 | length > 0
      no_log: true

    - name: Add GitHub to known hosts
      ansible.builtin.known_hosts:
        name: github.com
        key: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
        state: present
      when: ssh_private_key_b64 | length > 0
